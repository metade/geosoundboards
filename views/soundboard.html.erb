<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset=utf-8 />
  <meta name="viewport" content="width=620" />
  <title>GeoSoundboards <%= @title %></title>
  <script type="text/javascript" src="http://code.jquery.com/jquery-1.5.min.js"></script>
</head>
<body>
<section id="wrapper">
  <header>
    <h1><%= @title %></h1>
  </header>
  
  <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
  <article>
    <p>Finding your location: <span id="status">checking...</span></p>
  </article>
</section>

<script>
var map;
var marker;
var soundboard = <%= @soundboard.to_json %>;
function success(position) {
  var s = document.querySelector('#status');
  
  if (s.className == 'success') {
    // not sure why we're hitting this twice in FF, I think it's to do with a cached result coming back    
    return;
  }
  
  s.innerHTML = "found you!";
  s.className = 'success';
  
  var mapcanvas = document.createElement('div');
  mapcanvas.id = 'mapcanvas';
  mapcanvas.style.height = '400px';
  mapcanvas.style.width = '560px';
    
  document.querySelector('article').appendChild(mapcanvas);
  
  var latlng = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
  var myOptions = {
    zoom: 15,
    center: latlng,
    mapTypeControl: false,
    navigationControlOptions: {style: google.maps.NavigationControlStyle.SMALL},
    mapTypeId: google.maps.MapTypeId.ROADMAP
  };
  map = new google.maps.Map(document.getElementById("mapcanvas"), myOptions);
  marker = new google.maps.Marker({ 
    position: latlng, 
    map: map,
    draggable:true,
    icon:'http://maps.google.com/mapfiles/ms/micons/blue.png',
    title:"You are here!"
  });
  
  for (i in soundboard) {
    var sound = soundboard[i];
    var point = randomPoint(position);
    sound.marker = new google.maps.Marker({ 
      position: point,
      map: map, 
      title: sound.title,
      icon:'http://maps.google.com/mapfiles/ms/micons/orange.png',
    });
  }
}

function update(position) {
  var latlng = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
  console.log('updated: ' + latlng.lat() + ' ' + latlng.lng());
  marker.position = latlng;
  for (i in soundboard) {
    var sound = soundboard[i];
    var distance = haversine(marker.position, sound.marker.position);
    if (distance < 0.02) {
      document.getElementById('sound-'+i).play();
    }
  }
}

function randomPoint(p) {
  var d = (-0.005 + Math.random() / 100.0);
  var lat = p.coords.latitude + (-0.005 + Math.random() / 100.0);
  var lon = p.coords.longitude + (-0.005 + Math.random() / 100.0);
  var point = new google.maps.LatLng(lat,lon);
  return point;
}

// from: http://www.movable-type.co.uk/scripts/latlong.html
if (typeof(Number.prototype.toRad) === "undefined") {
  Number.prototype.toRad = function() {
    return this * Math.PI / 180;
  }
}
function haversine(a, b) {
  var R = 6371; // km
  var dLat = (b.lat()-a.lat()).toRad();
  var dLon = (b.lng()-a.lng()).toRad(); 
  var a = Math.sin(dLat/2) * Math.sin(dLat/2) +
          Math.cos(a.lat().toRad()) * Math.cos(b.lat().toRad()) * 
          Math.sin(dLon/2) * Math.sin(dLon/2); 
  var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
  var d = R * c;
  return d;
}

function error(msg) {
  var s = document.querySelector('#status');
  s.innerHTML = typeof msg == 'string' ? msg : "failed";
  s.className = 'fail';
}

if (navigator.geolocation) {
  navigator.geolocation.getCurrentPosition(success, error);
  navigator.geolocation.watchPosition(function(position) {
    update(position);
  });
} else {
  error('not supported');
}
// success({'coords': { 'latitude': 51.54634890444444, 'longitude': -0.038198593333333336 }});
// update({'coords': { 'latitude': 51.54634890444444, 'longitude': -0.038198593333333336 }});

</script>

<% @soundboard.each_with_index do |sound,i| %>
<audio id="sound-<%= i %>" src="http://www.bbc.co.uk<%= sound[:path] %>.mp3"></audio>
<% end %>

</body>
</html>
